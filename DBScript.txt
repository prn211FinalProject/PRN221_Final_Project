-- Tạo cơ sở dữ liệu LibraryManagement
--CREATE DATABASE LMS_PRN221;
--DROP DATABASE LMS_PRN221;

-- Sử dụng cơ sở dữ liệu LibraryManagement
USE LMS_PRN221;
Go

-- Bảng Role (vai trò của user)
CREATE TABLE Role (
    Id INT PRIMARY KEY IDENTITY,
    Name NVARCHAR(255),
    Status BIT
);

-- Bảng User (người dùng)
CREATE TABLE [User] (
    Uid INT PRIMARY KEY IDENTITY,
    FullName NVARCHAR(255),
    Email NVARCHAR(255) UNIQUE,
    Phone NVARCHAR(20),
    Status BIT,
	Gender BIT,
	[Password] varchar(255),
	[Image] varchar(255),
    RoleId INT FOREIGN KEY REFERENCES Role(Id)
);

-- Bảng Category (thể loại sách)
CREATE TABLE Category (
    Id INT PRIMARY KEY IDENTITY,
    CName NVARCHAR(255),
    Status BIT
);

-- Bảng Publisher (nhà xuất bản)
CREATE TABLE Publisher (
    Id INT PRIMARY KEY IDENTITY,
    PName NVARCHAR(255),
    Address NVARCHAR(255),
    Phone NVARCHAR(20),
    Email NVARCHAR(255),
    Status BIT
);

-- Bảng Book (sách)
CREATE TABLE BookTitle (
    Id INT PRIMARY KEY IDENTITY,
    CId INT FOREIGN KEY REFERENCES Category(Id),
    BName NVARCHAR(255),
    Author NVARCHAR(255),
    Quantity INT,
	UnitInStock int,
    Image NVARCHAR(255),
    Price DECIMAL(10, 2),
	[Description] nvarchar(255),
    Status BIT,
	[Hide] BIT NOT NULL DEFAULT 0,
    PublisherId INT FOREIGN KEY REFERENCES Publisher(Id),
    PublishDate DATETIME
);
CREATE TABLE BookCopy (
    Id varchar(255) primary key,
    BookTitleId INT,
    Status bit,
    Note NVARCHAR(255),
    FOREIGN KEY (BookTitleId) REFERENCES BookTitle(Id),
);
-- Bảng Feedback (đánh giá sách)
CREATE TABLE Feedback (
    Id INT PRIMARY KEY IDENTITY,
    Bid INT FOREIGN KEY REFERENCES BookTitle(Id),
    Uid INT FOREIGN KEY REFERENCES [User](Uid),
    Content NVARCHAR(MAX),
    CreatedDate DATETIME,
    Status BIT
);

-- Bảng Wishlist (danh sách yêu thích của người dùng)
CREATE TABLE Wishlist (
    Id INT PRIMARY KEY IDENTITY,
    Uid INT FOREIGN KEY REFERENCES [User](Uid)
);

-- Bảng WishlistItem (mục trong danh sách yêu thích)
CREATE TABLE WishlistItem (
    WId INT FOREIGN KEY REFERENCES Wishlist(Id),
    BId varchar(255) FOREIGN KEY REFERENCES BookCopy(Id),
    PRIMARY KEY (WId, BId)
);

-- Bảng Borrow Information (thông tin mượn sách)
CREATE TABLE BorrowInformation (
    Oid INT PRIMARY KEY IDENTITY,
    Uid INT FOREIGN KEY REFERENCES [User](Uid),
    BorrowDate DATETIME,
	CheckoutDate DateTime,
    DueDate DATETIME,
	ReturnDate DATETIME,
    TotalAmount DECIMAL(10, 2),
    Note NVARCHAR(MAX),
    Status int
);

-- Bảng Borrow Detail (chi tiết mượn sách)
CREATE TABLE BorrowDetail (
    Oid INT FOREIGN KEY REFERENCES BorrowInformation(Oid),
    Bid varchar(255) FOREIGN KEY REFERENCES BookCopy(Id),
    PRIMARY KEY (Oid, Bid)
);

-- Bảng Blog (blog về sách hoặc hệ thống)
CREATE TABLE Blog (
    Bid INT PRIMARY KEY IDENTITY,
    Title NVARCHAR(255),
    Content NVARCHAR(MAX),
    CreatedDate DATETIME,
    Status BIT,
	Uid INT FOREIGN KEY REFERENCES [User](Uid)
);
CREATE TABLE Penalty (
    Id INT PRIMARY KEY IDENTITY,
    Oid INT FOREIGN KEY REFERENCES BorrowInformation(Oid), -- liên kết đến bảng BorrowInformation
    Uid INT FOREIGN KEY REFERENCES [User](Uid), -- người dùng bị phạt
    Amount DECIMAL(10, 2) NOT NULL, -- số tiền phạt
    Reason NVARCHAR(255), -- lý do phạt (ví dụ: "Trả sách muộn")
    CreatedDate DATETIME DEFAULT GETDATE(), -- ngày phạt
    Status BIT NOT NULL DEFAULT 1 -- trạng thái của phạt (1: chưa thanh toán, 0: đã thanh toán)
);
ALTER TABLE BorrowInformation
ADD PenaltyAmount DECIMAL(10, 2) DEFAULT 0; 
ALTER TABLE BorrowInformation
ADD PenaltyStatus BIT DEFAULT 1;
ALTER TABLE BookTitle
CREATE TRIGGER trg_CalculatePenalty
ON BorrowInformation
AFTER UPDATE
AS
BEGIN
    DECLARE @Oid INT, @Uid INT, @ReturnDate DATETIME, @DueDate DATETIME, @LateDays INT, @PenaltyAmount DECIMAL(10, 2);
    SET @PenaltyAmount = 0; -- Khoản phạt khởi điểm
    
    -- Lấy các thông tin của giao dịch mượn sách bị cập nhật
    SELECT @Oid = INSERTED.Oid, @Uid = INSERTED.Uid, @ReturnDate = INSERTED.ReturnDate, @DueDate = INSERTED.DueDate
    FROM INSERTED
    WHERE INSERTED.ReturnDate IS NOT NULL; -- Chỉ tính khi sách đã được trả

    -- Kiểm tra xem người dùng có trả sách muộn không
    IF (@ReturnDate > @DueDate)
    BEGIN
        -- Tính số ngày trả muộn và tiền phạt (giả sử phạt 5000 VND/ngày)
        SET @LateDays = DATEDIFF(DAY, @DueDate, @ReturnDate);
        SET @PenaltyAmount = @LateDays * 5000; -- Mức phạt cho mỗi ngày trả muộn

        -- Thêm khoản phạt vào bảng Penalty
        INSERT INTO Penalty (Oid, Uid, Amount, Reason, CreatedDate, Status)
        VALUES (@Oid, @Uid, @PenaltyAmount, N'Trả sách muộn', GETDATE(), 1);

        -- Cập nhật tổng tiền phạt vào BorrowInformation
        UPDATE BorrowInformation
        SET PenaltyAmount = @PenaltyAmount
        WHERE Oid = @Oid;
    END
END;
Create table PasswordResetToken(
 Id int primary key NOT NULL IDENTITY(1,1),
 UserId int foreign key references [User](UId),
 Token varchar(255),
 Expiration DateTime
 )
CREATE TABLE LibrarianOrder (
    Id INT PRIMARY KEY IDENTITY,
    LibrarianId INT FOREIGN KEY REFERENCES [User](Uid),  -- User ID của Librarian
    BorrowOrderId INT FOREIGN KEY REFERENCES BorrowInformation(Oid),  -- ID của đơn mượn sách
    AssignmentDate DATETIME DEFAULT GETDATE(),  -- Ngày tiếp nhận đơn mượn
    Status BIT  -- Trạng thái xử lý đơn mượn (0: Đang xử lý, 1: Đã hoàn thành)
);
--- Thêm dữ liệu vào bảng Role (vai trò của user)
INSERT INTO Role (Name, Status)
VALUES 
    (N'Admin', 1),
    (N'Customer', 1);

-- Thêm dữ liệu vào bảng User (người dùng)
INSERT INTO [User] (FullName, Email, Phone, Status, Gender, [Password], [Image], RoleId)
VALUES
    (N'Alice Smith', 'alice@example.com', '1234567890', 1, 1, 'password123', 'alice.jpg', 1),  -- Admin
    (N'Bob Johnson', 'bob@example.com', '0987654321', 1, 0, 'password456', 'bob.jpg', 2);       -- Customer

-- Thêm dữ liệu vào bảng Category (thể loại sách)
INSERT INTO Category (CName, Status)
VALUES
    (N'Fiction', 1),
    (N'Non-Fiction', 1),
    (N'Science Fiction', 1),
    (N'Biography', 1);

-- Thêm dữ liệu vào bảng Publisher (nhà xuất bản)
INSERT INTO Publisher (PName, Address, Phone, Email, Status)
VALUES
    (N'Penguin Books', N'123 Book St', '1112223333', 'contact@penguin.com', 1),
    (N'HarperCollins', N'456 Publisher Ave', '4445556666', 'info@harpercollins.com', 1);

-- Thêm dữ liệu vào bảng BookTitle (sách)
INSERT INTO BookTitle (CId, BName, Author, Quantity, UnitInStock, Image, Price, [Description], Status, [Hide], PublisherId, PublishDate)
VALUES
    (1, N'To Kill a Mockingbird', N'Harper Lee', 10, 5, 'mockingbird.jpg', 15.99, N'A classic novel.', 1, 0, 1, '1960-07-11'),
    (3, N'Dune', N'Frank Herbert', 5, 3, 'dune.jpg', 22.50, N'Science fiction novel.', 1, 0, 2, '1965-08-01');

-- Thêm dữ liệu vào bảng BookCopy (bản sao của sách)
INSERT INTO BookCopy (Id, BookTitleId, Status, Note)
VALUES
    ('BC001', 1, 1, N'Good condition'),
    ('BC002', 1, 0, N'Checked out'),
    ('BC003', 2, 1, N'New arrival');

-- Thêm dữ liệu vào bảng Feedback (đánh giá sách)
INSERT INTO Feedback (Bid, Uid, Content, CreatedDate, Status)
VALUES
    (1, 2, N'Great read, highly recommend!', '2024-01-01', 1),
    (2, 2, N'Amazing storyline and world-building.', '2024-02-15', 1);

-- Thêm dữ liệu vào bảng Wishlist (danh sách yêu thích của người dùng)
INSERT INTO Wishlist (Uid)
VALUES
    (2);  -- Thêm danh sách yêu thích cho khách hàng (User ID 2)

-- Thêm dữ liệu vào bảng WishlistItem (mục trong danh sách yêu thích)
INSERT INTO WishlistItem (WId, BId)
VALUES
    (1, 'BC001'),  -- Thêm bản sao "To Kill a Mockingbird" vào danh sách yêu thích
    (1, 'BC003');  -- Thêm bản sao "Dune" vào danh sách yêu thích

-- Thêm dữ liệu vào bảng BorrowInformation (thông tin mượn sách)
INSERT INTO BorrowInformation (Uid, BorrowDate, CheckoutDate, DueDate, TotalAmount, Note, Status)
VALUES
    (2, '2024-03-01', '2024-03-02', '2024-03-15', 15.99, N'First-time borrow', 1);
-- Thêm dữ liệu vào bảng BorrowDetail (chi tiết mượn sách)
INSERT INTO BorrowDetail (Oid, Bid)
VALUES
    (1, 'BC001');  -- Bản sao "To Kill a Mockingbird" trong chi tiết mượn sách
INSERT INTO BorrowDetail (Oid, Bid)
VALUES
    (1, 'BC003'); 
-- Thêm dữ liệu vào bảng Blog (blog về sách hoặc hệ thống)
INSERT INTO Blog (Title, Content, CreatedDate, Status, Uid)
VALUES
    (N'Book Review: To Kill a Mockingbird', N'This book is a profound story...', '2024-04-01', 1, 1),
    (N'Science Fiction Spotlight', N'A review of the Dune series...', '2024-04-15', 1, 2);

-- Xác minh dữ liệu đã được thêm
SELECT * FROM Role;
SELECT * FROM [User];
SELECT * FROM Category;
SELECT * FROM Publisher;
SELECT * FROM BookTitle;
SELECT * FROM BookCopy;
SELECT * FROM Feedback;
SELECT * FROM Wishlist;
SELECT * FROM WishlistItem;
SELECT * FROM BorrowInformation;
SELECT * FROM BorrowDetail;
SELECT * FROM Blog;